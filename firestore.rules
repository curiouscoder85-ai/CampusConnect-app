
/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data and teacher-ownership for course-related data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the user can read/write their own profile. Admins can read all profiles.
 * - /courses/{courseId}: Stores course information. Only the teacher who created the course can modify it.
 * - /users/{userId}/certificates/{certificateId}: Stores certificates earned by users. Only the user can access their own certificates.
 * - /courses/{courseId}/feedback/{feedbackId}: Stores feedback for each course. Only the teacher who created the course can manage feedback. Students can create feedback.
 * - /enrollments/{enrollmentId}: Stores enrollment records. Only the student or the teacher of the course can access. Student can update their own progress.
 * - /submissions/{submissionId}: Stores submissions for assignments. Only the student who created it or teacher of the course can access. Teacher can grade.
 * - /users/{userId}/recommendations/{recommendationId}: Stores AI-powered content recommendations for each student. Only the user can access their own recommendations.
 *
 * Key Security Decisions:
 * - User listing is allowed for all signed-in users.
 * - Data shapes are not strictly enforced, focusing on authorization.
 * - Ownership is enforced using path-based matching and denormalized fields like 'teacherId'.
 * - Ambiguous relationships default to strict owner-only access.
 *
 * Denormalization for Authorization:
 * - Course documents have a `teacherId` field to identify the owner.
 * - Enrollment, Submission, and Feedback documents store `courseId`, `studentId`, and `teacherId`.
 *
 * Structural Segregation:
 * - User-specific data (e.g., certificates, recommendations) is stored under `/users/{userId}` to ensure private access.
 * - Submissions are now a root collection for easier querying by teachers.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isRole(role) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isSignedIn() && userDoc.data.role == role;
    }
    
    function isSignedIn() {
      return request.auth != null;
    }

    match /users/{userId} {
      function isOwner() {
        return isSignedIn() && request.auth.uid == userId;
      }
      
      allow list: if isSignedIn();
      allow get: if isSignedIn();
      allow create: if isOwner() && request.resource.data.id == userId || isRole('admin');
      allow update: if isOwner() || isRole('admin');
      allow delete: if isRole('admin');
    }

    match /courses/{courseId} {
      function isTeacherOwner() {
          return isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid;
      }

      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid && isRole('teacher');
      allow update: if (isTeacherOwner() || isRole('admin'));
      allow delete: if (isTeacherOwner() || isRole('admin'));
    }

    match /users/{userId}/certificates/{certificateId} {
      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    match /courses/{courseId}/feedback/{feedbackId} {
      function isTeacherOwner(courseId) {
          return isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isTeacherOwner(courseId);
      allow delete: if isTeacherOwner(courseId);
    }

    match /enrollments/{enrollmentId} {
      function isStudentEnrolled(studentId) {
          return isSignedIn() && request.auth.uid == studentId;
      }

      function isTeacherOfCourse(courseId) {
        return isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid;
      }

      allow get: if isStudentEnrolled(resource.data.userId) || isTeacherOfCourse(resource.data.courseId);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if (isStudentEnrolled(resource.data.userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['progress', 'completedContent', 'completed'])) || isTeacherOfCourse(resource.data.courseId);
      allow delete: if isStudentEnrolled(resource.data.userId) || isTeacherOfCourse(resource.data.courseId);
    }

    match /submissions/{submissionId} {
        function isTeacherOfCourse(courseId) {
            return isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid;
        }

        function isStudentOwner() {
            return isSignedIn() && resource.data.userId == request.auth.uid;
        }
        
        allow get: if isStudentOwner() || isTeacherOfCourse(resource.data.courseId);
        allow list: if isRole('teacher');
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isTeacherOfCourse(resource.data.courseId); // Allow teacher to update (e.g., for grading)
        allow delete: if isStudentOwner() || isTeacherOfCourse(resource.data.courseId);
    }

    match /users/{userId}/recommendations/{recommendationId} {
      function isOwner(ownerId) {
        return isSignedIn() && request.auth.uid == ownerId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    match /{path=**}/feedback/{feedbackId} {
      allow list: if isRole('admin') || isRole('teacher');
    }
  }
}
